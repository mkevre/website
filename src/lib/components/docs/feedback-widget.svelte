<script lang="ts">
  // Credit: www.vercel.com/docs 🙏
  import { page } from "$app/stores";
  import { trackEvent } from "../segment.svelte";
  import Textarea from "$lib/components/ui-library/textarea";
  import Button from "$lib/components/ui-library/button";

  let selectedEmotion: number;
  let note = "";
  let resultMessage: string;
  let isSubmittedOnce = false;
  let clazz = "";
  export { clazz as class };
  export let type: "docs" | "guides" | "digests";

  const submitFeedback = async () => {
    isSubmittedOnce = true;

    trackEvent("feedback_submitted", {
      score: selectedEmotion,
      feedback: note,
      url: window.location.href,
      path: window.location.pathname,
    });

    const response = await fetch("/.netlify/functions/feedback", {
      method: "post",
      body: JSON.stringify({
        type,
        emotion: selectedEmotion,
        note,
        url: $page.url.toString(),
      }),
    });

    if (response.status === 201) {
      resultMessage = "Thanks for your feedback, we appreciate it.";
    } else {
      resultMessage = "Oh no, something went wrong :(.";
    }
    setTimeout(() => {
      selectedEmotion = undefined;
      note = "";
      resultMessage = "";
    }, 5000);
  };
</script>

<style lang="postcss">
  .selected {
    @apply scale-150 grayscale-0;
  }
</style>

<div class={clazz}>
  <div
    class="m-auto max-w-md rounded-2xl bg-white py-small px-xx-small shadow-normal"
    data-analytics={`{"dnt":true}`}>
    <h2 class="mb-6 w-full justify-center text-center text-xl leading-6">
      Was this helpful?
    </h2>
    {#if resultMessage}
      <p class="text-center">{resultMessage}</p>
    {:else}
      <form on:submit|preventDefault={submitFeedback}>
        <div class="flex justify-center space-x-6">
          {#each new Array(4) as _, index}
            <button
              on:click|preventDefault={() => (selectedEmotion = index + 1)}
              class:selected={selectedEmotion === index + 1}
              class="grayscale transition duration-150 hover:grayscale-0 hover:scale-150">
              <img
                src="/images/docs/feedback-widget/{index + 1}.svg"
                alt="Feedback {index + 1} of 4"
                title="Feedback {index + 1} of 4"
                class="h-6 w-6" />
            </button>
          {/each}
        </div>
        {#if selectedEmotion}
          <div class="mt-x-small">
            <Textarea
              label="Feedback"
              bind:value={note}
              id="note"
              name="feedback"
              width="100%"
              placeholder="Your feedback..."
              aria-label="Feedback input"
              autocapitalize="off"
              autocomplete="off"
              autocorrect="off"
              type="text"
              class="mb-0" />
            <div>
              <span>
                <Button
                  variant="primary"
                  size="medium"
                  disabled={isSubmittedOnce}
                  class="mt-micro"
                  type="submit"><span>Send</span></Button>
              </span>
            </div>
          </div>
        {/if}
      </form>
    {/if}
  </div>
</div>
